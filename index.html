<!DOCTYPE html>
<html>
  <head>
    <title>Monitoring Energi Listrik</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background-color: #f0f2f5;
      }
      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 20px;
      }
      .card {
        background: white;
        padding: 15px 20px;
        margin: 10px 0;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 15px;
        font-size: 16px;
      }
      .icon {
        font-size: 20px;
        width: 25px;
      }
      .blue {
        color: #007bff;
      }
      .green {
        color: #28a745;
      }
      .orange {
        color: #fd7e14;
      }
      .purple {
        color: #6f42c1;
      }
      .red {
        color: #dc3545;
      }
      .teal {
        color: #20c997;
      }
      .yellow {
        color: #ffc107;
      }
      .relay-btn {
        margin-top: 10px;
        padding: 10px;
        border: none;
        background-color: #007bff;
        color: white;
        border-radius: 5px;
        cursor: pointer;
      }
      #chartContainer {
        background: white;
        border-radius: 10px;
        padding: 15px 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <h1>ðŸ”Œ Monitoring Energi Listrik</h1>

    <div class="card">
      <i class="fas fa-bolt icon blue"></i> Tegangan:
      <span id="voltage">0</span> V
    </div>
    <div class="card">
      <i class="fas fa-plug icon orange"></i> Daya Semu:
      <span id="apparentPower">0</span> VA
    </div>
    <div class="card">
      <i class="fas fa-battery-half icon teal"></i> Arus (mA):
      <span id="current_mA">0</span> mA
    </div>
    <div class="card">
      <i class="fas fa-lightbulb icon yellow"></i> Daya Aktif:
      <span id="power">0</span> W
    </div>
    <div class="card">
      <i class="fas fa-wave-square icon purple"></i> Daya Reaktif:
      <span id="reactivePower">0</span> VAR
    </div>
    <div class="card">
      <i class="fas fa-tachometer-alt icon red"></i> Energi:
      <span id="energy">0</span> KWh
    </div>
    <div class="card">
      <i class="fas fa-broadcast-tower icon purple"></i> Frekuensi:
      <span id="frequency">0</span> Hz
    </div>
    <div class="card">
      <i class="fas fa-percentage icon teal"></i> Power Factor:
      <span id="pf">0</span>
    </div>

    <div class="card">
      <i class="fas fa-power-off icon red"></i> Relay Status:
      <span id="relayStatus">OFF</span><br />
      <button class="relay-btn" onclick="toggleRelay()">Toggle Relay</button>
    </div>

    <div id="chartContainer">
      <canvas id="currentChart" height="150"></canvas>
    </div>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAMqxkBgNXzF4aB8dk5DdcUdY8XRL-9rNI",
        authDomain: "home-25fd1.firebaseapp.com",
        databaseURL: "https://home-25fd1-default-rtdb.firebaseio.com",
        projectId: "home-25fd1",
        storageBucket: "home-25fd1.appspot.com",
        messagingSenderId: "893440021332",
        appId: "1:893440021332:web:bcfc9f399146df35696ec1",
        measurementId: "G-G1EJP0CJH3",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      const monitoringRef = db.ref("monitoring");

      // Setup Chart.js grafik arus
      const ctx = document.getElementById("currentChart").getContext("2d");
      const currentData = {
        labels: [], // timestamps atau counter
        datasets: [
          {
            label: "Arus (mA)",
            backgroundColor: "rgba(32, 201, 151, 0.5)",
            borderColor: "#20c997",
            fill: true,
            data: [],
            tension: 0.3,
          },
        ],
      };
      const currentChart = new Chart(ctx, {
        type: "line",
        data: currentData,
        options: {
          responsive: true,
          animation: false,
          scales: {
            x: {
              display: true,
              title: { display: true, text: "Waktu" },
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: "Arus (mA)" },
            },
          },
          plugins: {
            legend: {
              display: true,
              position: "top",
            },
          },
        },
      });

      monitoringRef.on("value", (snapshot) => {
        const data = snapshot.val();

        document.getElementById("voltage").textContent = data.voltage ?? "0";
        document.getElementById("apparentPower").textContent =
          data.apparent_power ?? "0";
        document.getElementById("current_mA").textContent =
          data.current_mA ?? "0";
        document.getElementById("power").textContent = data.power ?? "0";
        document.getElementById("energy").textContent = data.energy ?? "0";
        document.getElementById("frequency").textContent =
          data.frequency ?? "0";
        document.getElementById("pf").textContent = data.pf ?? "0";
        document.getElementById("relayStatus").textContent = data.relay
          ? "ON"
          : "OFF";
        document.getElementById("reactivePower").textContent =
          data.reactive_power ?? "0";

        // Update grafik arus
        const now = new Date();
        const timeLabel = now.toLocaleTimeString();

        // Batasi data maksimum 30 poin
        if (currentData.labels.length >= 30) {
          currentData.labels.shift();
          currentData.datasets[0].data.shift();
        }
        currentData.labels.push(timeLabel);
        currentData.datasets[0].data.push(Number(data.current_mA) || 0);
        currentChart.update();
      });

      function toggleRelay() {
        monitoringRef.child("relay").once("value", (snapshot) => {
          const currentStatus = snapshot.val();
          monitoringRef.update({ relay: !currentStatus });
        });
      }
    </script>
  </body>
</html>
